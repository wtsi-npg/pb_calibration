#!/bin/bash

#########################################################################
#
# run pb_align
#
# for usage run
#
#   pb_align -h
#
#########################################################################

initialise ()
{

    # set defaults
    bam=""
    read=""
    read1=""
    read2=""
    pf_filter=""
    ref=""
    prefix=""
    aln_parms=""
    spatial_filter=""
    intensity_dir=""
    sf_parms=""

    TEMP=`getopt -a -o h --long bam:,read:,read1:,read2:,pf_filter,ref:,aln_parms:,spatial_filter,intensity_dir:,sf_parms:,prefix:,help -n $0 -- "$@"`

    if [ $? != 0 ] ; then echo "Terminating..." >&2 ; exit 1 ; fi

    eval set -- "$TEMP"

    while true ; do
        case "$1" in
            --bam) bam=$2; echo "input bam file $bam" >&2; shift 2 ;;
            --read) read=$2; echo "read $read" >&2; shift 2 ;;
            --read1) read1=$2; echo "read1 $read1" >&2; shift 2 ;;
            --read2) read2=$2; echo "read2 $read2" >&2; shift 2 ;;
            --pf_filter) pf_filter=1; echo "will purity filter" >&2; shift 1 ;;
            --ref) ref=$2; echo "reference $ref" >&2; shift 2 ;;
            --aln_parms) aln_parms=$2; echo "aln_parms options $aln_parms" >&2; shift 2 ;;
 	    --spatial_filter) spatial_filter=1; echo "will apply spatial_filter" >&2; shift 1 ;;
            --intensity_dir) intensity_dir=$2; echo "intensity_dir $intensity_dir" >&2; shift 2 ;;
	    --sf_parms) sf_parms=$2; echo "sf_parms options $sf_parms" >&2; shift 2 ;;
            --prefix) prefix=$2; echo "prefix $prefix" >&2; shift 2 ;;
            -h|--help) echo "Usage: $0 [options]";
                       echo "                   ";
                       echo "       -bam <bam file>";
                       echo "                   ";
                       echo "       -read <read>        0-single-ended read in bam file, 1-first read in bam file, 2-second read in bam file";
                       echo "                             single read, no default";
                       echo "       -read1 <read1>      1-first read in bam file, 2-second read in bam file";
                       echo "       -read2 <read2>      1-first read in bam file, 2-second read in bam file";
                       echo "                             paired reads, no default";
                       echo "                   ";
                       echo "       -pf_filter          purity filter reads";
                       echo "                             default do not purity filter reads";
                       echo "                   ";
                       echo "                   ";
                       echo "       -ref <ref>          full path to reference";
                       echo "                   ";
                       echo "       -aln_parms <bwa aln parameters>";
                       echo "                             no default";
                       echo "                   ";
                       echo "                   ";
                       echo "       -spatial_filter     apply spatial filtering to the bam files";
                       echo "                   ";
                       echo "       -intensity_dir <raw intensity directory>";
                       echo "                   ";
                       echo "       -sf_parms <spatial_filter parameters>";
                       echo "                             no default";
                       echo "                   ";
                       echo "       -prefix <prefix>    output file prefix";
                       echo "                             no default";
                       echo "                   ";
                       echo "       -h|--help   ";
                       echo "                   ";
                       exit 0 ;;
            --) shift ; break ;;
            *) echo "Unrecognised option $1" >&2; exit 1 ;;
        esac
    done

    if [ -z $bam ] ; then
        echo "You must supply a bam file" >&2
        exit 1
    fi

    if [ -z $read ] && ( [ -z $read1 ] || [ -z $read2 ] ) ; then
        echo "You must specify read or read1+read2" >&2
        exit 1
    fi

    if [ $read ] && ( [ $read1 ] || [ $read2 ] ) ; then
        echo "You must specify read OR read1+read2 not both" >&2
        exit 1
    fi

    if [ -z $ref ] ; then
        echo "You must specify a reference" >&2
        exit 1
    fi

    if [ $spatial_filter ] && [ -z $intensity_dir ] ; then
        echo "You must supply an intensity_dir if you want to apply a spatial filter" >&2
        exit 1
    fi

    if [ -z $prefix ] ; then
        echo "You must supply a prefix" >&2
        exit 1
    fi
}

set -o errexit
set -o nounset

tools=$(dirname $0)
tools=$(readlink -f $tools)
bwa=$(which bwa)
bwa=$(readlink -e $bwa)

initialise "$@"

if [ -z $ref ] ; then
  echo "You must specify the full path to the reference" >&2
  exit 1
fi

echo "Output file prefix ${prefix}" >&2

if [ ! -s $bam ] ; then
    echo "input bam file $bam does not exist" >&2
    exit 1
fi

output=${prefix}.bam
echo "Making bam file $output" >&2

picard_jar="/software/solexa/bin/aligners/illumina2bam/current/BamMerger.jar"
if [ $read ] ; then
  picard_parms="VALIDATION_STRINGENCY=SILENT QUIET=true INPUT=$bam ALIGNED=/dev/stdin OUTPUT=$output"
else
  picard_parms="VALIDATION_STRINGENCY=SILENT QUIET=true INPUT=$bam ALIGNED=/dev/stdin COMPRESSION_LEVEL=0 OUTPUT=/dev/stdout"
fi

if [ $pf_filter ] ; then
  filter=512
else
  filter=0
fi

if [ $read ] ; then
    sai=${prefix}.sai
    bwa aln $aln_parms $ref -b${read} $bam > $sai

    bwa samse $ref $sai $bam \
     | perl -aF'\t' -ne 'BEGIN{$filter=int(shift)} print unless ($F[1] & $filter || $F[1] & 4)' $filter \
     | java -Xmx1024M -jar $picard_jar $picard_parms
else
    sai1=${prefix}_1.sai
    bwa aln $aln_parms $ref -b1 $bam > $sai1

    sai2=${prefix}_2.sai
    bwa aln $aln_parms $ref -b2 $bam > $sai2

    bwa sampe $ref $sai1 $sai2 $bam $bam \
     | perl -aF'\t' -ne 'BEGIN{$filter=int(shift)} print unless ($F[1] & $filter || ($F[1] & 4 && $F[1] & 8))' $filter \
     | java -Xmx1024M -jar $picard_jar $picard_parms | samtools fixmate - $output
fi

if [ ! -s $output ] ; then
    echo "failed to create output file $output" >&2
    exit 1
fi

stat_file=${prefix}_flagstat.txt
samtools flagstat $output > $stat_file
if [ ! -s $stat_file ] ; then
    echo "failed to create flagstat file" >&2
    exit 1
fi

pair=`awk '/[0-9]+ paired in sequencing/ {print $1+$3}' $stat_file`
if [ $pair -gt 0 ] ; then
    count=`awk '/[0-9]+ properly paired/ {print $1}' $stat_file`
    if [ $count -lt 200000 ] ; then
        echo "Only $count properly paired reads < 200000" >&2
        exit 0
    fi
else
    count=`awk '/[0-9]+ mapped/ {print $1}' $stat_file`
    if [ $count -lt 100000 ] ; then
        echo "Only $count reads align < 100000" >&2
        exit 0
    fi
fi

echo "Making spatial filter..." >&2

#
# Spatial Filter options
# Added 8 Oct 2012 by js10
#
if [ $spatial_filter ] ; then
	$tools/spatial_filter -c $sf_parms -i $intensity_dir --filter ${output}.filter $output
	if [ ! -s ${output}.filter ] ; then
		echo "spatial_filter failed to create a filter file ${output}.filter" >&2
		exit 1
	fi
	$tools/spatial_filter -a --filter ${output}.filter -o filtered_${output} $output
	if [ ! -s filtered_${output} ] ; then
		echo "spatial_filter failed to apply filter and produce filtered_${output}" >&2
		exit 1
	fi
	mv $output original_${output}
	mv filtered_${output} $output
fi

stat_file=${prefix}_flagstat.txt
samtools flagstat $output > $stat_file
if [ ! -s $stat_file ] ; then
    echo "failed to create flagstat file" >&2
    exit 1
fi

